<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新 王子复仇记</title>
    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f4f4f9;
            font-family: Arial, sans-serif;
        }

        .container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        h1 {
            font-size: 3rem;
            color: #391d1d;
            margin-bottom: 20px;
            font-weight: bold;
        }

        button {
            font-size: 1.5rem;
            padding: 15px 30px;
            color: #fff;
            background-color: #7f4b1e9a;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #bb541d;
        }

        .chat-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: #f4f4f9;
        }

        .chat-header {
            background-color: #6a6564;
            color: #fff;
            padding: 15px;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }

        .message {
            max-width: 70%;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 10px;
            line-height: 1.5;
        }

        .message.npc {
            background-color: #ffffff;
            align-self: flex-start;
            border: 1px solid #ccc;
        }

        .message.player {
            background-color: #222121;
            color: #fff;
            align-self: flex-end;
        }

        .message.narrator {
            background-color: #f0e68c;
            color: #333;
            text-align: center;
            align-self: center;
            border-radius: 5px;
            font-size: 0.9rem;
        }

        .chat-input {
            display: flex;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ccc;
        }

        .chat-input input[type="text"] {
            flex: 1;
            padding: 10px;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-right: 10px;
        }

        .chat-input button {
            padding: 10px 20px;
            font-size: 1rem;
            color: #fff;
            background-color: #5e3a1e;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .chat-input button:hover {
            background-color: #917443;
        }
        
        .end-conversation-btn {
            padding: 10px 20px;
            font-size: 1rem;
            color: #c75d5d;
            background-color: #FF4500;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            position: absolute;
            left: 10px;
            top: 15px;
        }
        
        .end-conversation-btn:hover {
            background-color: #FF4500;
        }

    </style>
</head>
<body>

    <div class="container" id="start-screen">
        <h1>新 王子复仇记</h1>
        <button onclick="startGame()">开始游戏</button>
    </div>

    <div class="chat-container" id="chat-screen" style="display: none;">
        <div class="chat-header">新 王子复仇记</div>
        <div class="chat-messages" id="chat-messages">
        </div>

        <div class="chat-input">
            <input type="text" id="player-input" placeholder="在这里输入消息..." />
            <button class="chat-input button" onclick="sendMessage()">发送</button>
            <button class="end-conversation-btn" onclick="endConversation()">结束对话</button>
        </div>


    <script>
        const APPID = '8b85b9c2';
        // 添加角色设定描述
        const characterDescription = "你扮演的是奥菲莉娅，《哈姆雷特》中的年轻女主角。您是一个善良且多愁善感的角色，对哈姆雷特有着深深的爱意，但同时也被家人（波洛涅斯和雷欧提斯）所控制。您的言辞应该优雅而内敛，充满诗意。无论玩家（哈姆雷特）如何回应，你都要保持角色的一致性，同时表现出细腻的情绪波动。请确保你的回答符合这一角色设定，并体现出奥菲莉娅的性格特点和情感状态。";
        const background = "现在是第三幕第一场。波洛涅斯认为，哈姆雷特的情感是虚假的，或者说即使是真的，也不适合继续发展，因为你的身份和家族地位无法与王室联姻。因此他要求你将你们的爱情信物退还给哈姆莱特。目前您全家都健在。您现在正在与哈姆雷特对话，以下是哈姆莱特对你说的话：";
        let socket;
        let isSocketConnected = false;  // 用来标记 WebSocket 是否已经连接
        let isEndingConversation = false; // 用于标记当前是否在 "结束对话" 场景
        let currentMessage = ''; // 用于保存当前的消息
        let typingTimer;
        let lastContent = '';  // 记录上一次的消息内容，用于避免重复

        addNarratorMessage("欢迎来到《新王子复仇记》，你准备好开始冒险了吗？<br>你将扮演哈姆雷特，自由与其它角色对话。<br>对话完成后请点击‘结束对话’按钮，你的对话将改变剧情走向。<br>您的父亲突然去世，母亲很快改嫁叔叔克劳狄斯，克劳狄斯随即成为了新国王。<br>士兵们在夜间的城墙上目睹了国王的幽灵，他们将这一情况告诉了你。<br>幽灵告诉你，他是被克劳狄斯毒杀的，并要求你为他复仇。<br>您决定假装疯癫，以暗中调查克劳狄斯的罪行。<br>母亲和克劳狄斯对您的精神状态感到担忧。<br>于王宫的大厅，您与您的恋人奥菲利娅偶遇，她试图将一些爱情信物归还您。<br>接下来请您与奥菲利娅对话。")
        
        /* 开始游戏并连接WebSocket */
        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            connectWebSocket();
        }

        /* 连接 WebSocket */
        function connectWebSocket() {
            const url = 'wss://maas-api.cn-huabei-1.xf-yun.com/v1.1/chat';
            socket = new WebSocket(url);

            socket.onopen = () => {
                console.log('WebSocket connected');
                isSocketConnected = true;  // 标记 WebSocket 已连接
            };

            socket.onerror = (error) => {
                console.error('WebSocket Error', error);
            };

            socket.onclose = () => {
                console.log('WebSocket closed');
                isSocketConnected = false;  // 标记 WebSocket 已关闭
            };
             // 在 connectWebSocket 函数中添加事件监听器
            socket.onmessage = handleWebSocketMessage;
        }

        /* 处理 WebSocket 消息 */
        function handleWebSocketMessage(event) {
            try {
                const response = JSON.parse(event.data);
                const content = response.payload.choices.text[0].content;

                // 如果是对话消息
                if (!isEndingConversation) {
                    if (content !== lastContent) {
                        currentMessage += content; 
                        lastContent = content; 
                        
                        clearTimeout(typingTimer);
                        typingTimer = setTimeout(() => {
                            addMessage(currentMessage, 'npc');
                            currentMessage = ''; 
                        }, 1000); 
                    }
                } 
                // 如果是结束对话
                else {
                    if (content !== lastContent) {
                        currentMessage += content; 
                        lastContent = content; 
                    }
                    clearTimeout(typingTimer);
                    typingTimer = setTimeout(() => {
                        processEndConversationResponse(currentMessage);
                        currentMessage = ''; 
                    }, 1000); 
                }

            } catch (error) {
                console.error('解析 WebSocket 数据时出错:', error);
            }
        }

        /* 向 WebSocket 发送消息 */
        function sendToWebSocket(message) {
            if (isSocketConnected) {
                const payload = {
                    "header": {
                        "app_id": APPID,
                        "uid": APPID, 
                        "patch_id": ["1868135224229920768"]
                    },
                    "parameter": {
                        "chat": {
                            "domain": "xqwen257bchat",
                            "temperature": 0.5
                        }
                    },
                    "payload": {
                        "message": {
                            "text": [
                                {"role": "user", "content": message} 
                            ]
                        }
                    }
                };
                console.log('Sending:', payload);
                socket.send(JSON.stringify(payload));
            } else {
                connectWebSocket();  // 重新连接 WebSocket
                setTimeout(() => sendToWebSocket(message), 1000);  // 重新发送消息
            }
        }
        // 发送玩家消息
        function sendMessage() {
            const input = document.getElementById('player-input');
            const message = input.value.trim();
            if (message !== '') {
                addMessage(message, 'player');
                sendToWebSocket(characterDescription+background+message);
            }
            input.value = '';
        }

        /* 在聊天窗口中添加消息 */
        function addMessage(text, sender) {
            const messageContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', sender);
            messageElement.innerHTML = text;
            messageContainer.appendChild(messageElement);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }

        /* 结束对话 */
        function endConversation() {
            // 获取历史对话消息
            var chatHistory = document.getElementById('chat-messages').innerText;

            // 构建要发送给 API 的消息
            var messageToSend = characterDescription + background + "以下是你们的历史对话："+ chatHistory + 
                                "请你根据历史消息，回答以下问题，你愿意私下找哈姆莱特谈心吗？只能回答是或者不是。";
            isEndingConversation = true; 
            currentMessage = ''; 
            sendToWebSocket(messageToSend);
        }

        function processEndConversationResponse(response) {
            console.log('结束对话的AI回答：', response);
            if (response.includes("不")) {
                addNarratorMessage("奥菲利娅感受到了背叛，同时又无法摆脱家人和社会的压力，她可能陷入更深的精神困扰。");
            } else if (response.includes("是")||response.includes("愿意")) {
                addNarratorMessage("奥菲利娅执意要寻求一个解答。她私下找您进行又一次沟通。");
            } else {
                addNarratorMessage("未能识别的回答：" + response);
            }
            
            setTimeout(function() {
                addNarratorMessage("非常抱歉，新王子复仇记demo到这里就结束了。<br>因为我本人是第一次做游戏，而且只接触过一次前端，所以游戏内容很贫乏。<br>我也不是文学专业的呀，可恶！<br>但是我相信就算是悲剧，主角们也应该有更美好的结局，所以选择了互动游戏的方式，希望能创造出不同的结局。<br>可惜我感觉AI比人类还死板......<br>无论如何，感谢您的观看！");
            }, 1000); 
            
            // 重置标志位
            isEndingConversation = false; 
        }

        function addNarratorMessage(text) {
            const messageContainer = document.getElementById('chat-messages');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'narrator');
            messageElement.innerHTML = text;
            messageContainer.appendChild(messageElement);
            messageContainer.scrollTop = messageContainer.scrollHeight;
        }
    </script>
</body>
</html>