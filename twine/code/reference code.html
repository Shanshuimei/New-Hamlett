<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心理辅导室</title>
    <style>
        body {
            background: url('F:/文档/Twine/故事/zixunshi2.jpeg') no-repeat center center fixed; /* 背景图片 */
            background-size: 1920px 1080px; /* 设置背景图片的尺寸为1920x1080像素 */
            margin: 0; /* 去除默认边距 */
            font-family: Arial, sans-serif; /* 设置字体 */
        }
        #chat-history {
            margin-top: 10px;
            border: 1px solid #bbb; /* 边框颜色 */
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            background-color: rgba(0,128,128, 0.9); /* 背景色稍微透明，便于阅读 */
            border-radius: 8px; /* 圆角边框 */
            font-size: 20px; /* 字体大小 */
            color: #ffffff; /* 字体颜色 */
        }
        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #4CAF50; /* 边框颜色 */
            border-radius: 4px;
            background-color: #20b2aa; /* 输入框背景颜色 */
            transition: background-color 0.3s; /* 背景颜色过渡效果 */
            font-size: 18px; /* 输入框字体大小 */
            color: #ffffff; /* 输入框字体颜色 */
        }
        input[type="text"]:hover {
            background-color: #008080; /* 鼠标悬停时的背景颜色 */
        }
        button {
            padding: 10px;
            border: none;
            background-color: #48d1cc;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 5px;
            font-size: 16px; /* 按钮字体大小 */
        }
    </style>
</head>
<body>

<div id="chat-history"></div>
<div style="margin-top: 10px; display: flex; align-items: center;">
    <input type="text" id="user-input" placeholder="输入你的问题..." />
    <button id="send-button">发送</button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
(function() {
    let conversationHistory = [
        {"role": "system", "content": "你要扮演xxx我是一个心理辅导师，我经营着一个心理辅导师..."}
    ];

    async function callGPT(prompt) {
        const apiUrl = "https://ai.thelazy.top/v1/chat/completions";

        try {
            const response = await fetch(apiUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": "Bearer sk-x9bn5IMAfQ7eMRekB583389bF2894cE7860dCd2eDe617942"
                },
                body: JSON.stringify({
                    model: "gpt-4o-mini-2024-07-18",
                    messages: conversationHistory,
                    temperature: 0.3
                })
            });

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error.message || "API 返回错误");
            }

            if (data.choices && data.choices[0] && data.choices[0].message) {
                return data.choices[0].message.content;
            } else {
                throw new Error("API 响应格式不符合预期");
            }
        } catch (error) {
            console.error("API调用错误:", error);
            throw error;
        }
    }

    function updateChatHistory() {
        const chatHistoryDiv = $("#chat-history");
        chatHistoryDiv.html(conversationHistory.map(msg => {
            if (msg.role === "system") return "";
            return `<p><strong>${msg.role === "user" ? "你" : "AI"}:</strong> ${msg.content}</p>`;
        }).join(""));
        chatHistoryDiv.scrollTop(chatHistoryDiv.prop("scrollHeight"));
    }

    async function handleUserInput() {
        const userInput = $("#user-input").val().trim();
        if (!userInput) return;

        conversationHistory.push({"role": "user", "content": userInput});
        updateChatHistory();

        $("#user-input").val("");
        
        try {
            const response = await callGPT(userInput);
            conversationHistory.push({"role": "assistant", "content": response});
            updateChatHistory();
        } catch (error) {
            console.error("完整错误信息:", error);
            conversationHistory.push({"role": "assistant", "content": "发生错误: " + error.message});
            updateChatHistory();
        }
    }

    $(document).ready(function() {
        const inputField = $("#user-input");
        const sendButton = $("#send-button");

        inputField.on("keydown", function(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                handleUserInput();
            }
        });

        sendButton.on("click", handleUserInput);
    });
})();
</script>

</body>
</html>
